
# アイスブレイクアプリ - 機能仕様書

## 概要

このアプリケーションは、チームメンバーを管理し、アイスブレイクセッションの当番を割り当てるためのユーザー管理機能および当番管理機能を提供します。

## データベース構造

### Usersテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|-----|-----|
| id | integer | PRIMARY KEY | 自動増分ID |
| name | string | NOT NULL | ユーザー名 |
| email | string | NOT NULL, UNIQUE | メールアドレス |
| slack_id | string | NOT NULL, UNIQUE | Slack ID |
| vacation_start_date | date | NULL可 | 休暇開始日 |
| vacation_end_date | date | NULL可 | 休暇終了日 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

### インデックス

- `email`カラムに一意インデックス

### DutyAssignmentsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|-----|-----|
| id | integer | PRIMARY KEY | 自動増分ID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID（外部キー） |
| assignment_date | date | NOT NULL | 当番日 |
| assignment_method | string | NOT NULL | 割り当て方法（custom） |
| status | string | NOT NULL | 状態（pending/completed/cancelled） |
| completed_at | datetime | NULL可 | 完了日時 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

### インデックス

- `user_id`カラムに外部キーインデックス
- `assignment_date`カラムにインデックス

## モデル仕様

### Userモデル

#### バリデーション

- **name**: 必須入力
- **email**: 必須入力、重複不可、有効なメールアドレス形式
- **slack_id**: 必須入力、重複不可

#### 関連付け

- `has_many :duty_assignments, dependent: :destroy`

#### メソッド

- `on_vacation?`: 現在休暇中かどうかを判定
- `available_for_duty?`: 当番割り当て可能かどうかを判定（休暇中でない）
- `full_name`: フルネームを返す（現在はnameと同じ）
- `last_duty_assignment`: 最新の当番割り当てを取得
- `total_duty_count`: 完了した当番の総数を取得

### DutyAssignmentモデル

#### バリデーション

- **assignment_date**: 必須入力
- **assignment_method**: 必須入力、customのみ
- **status**: 必須入力、pending/completed/cancelledのいずれか

#### 関連付け

- `belongs_to :user`

#### スコープ

- `pending`: 予定状態の当番を取得
- `completed`: 完了状態の当番を取得
- `for_date(date)`: 指定日の当番を取得
- `recent`: 日付の降順で取得

#### メソッド

- `mark_as_completed!`: 当番を完了状態にする
- `mark_as_cancelled!`: 当番をキャンセル状態にする
- `pending?`: 予定状態かどうかを判定
- `completed?`: 完了状態かどうかを判定
- `cancelled?`: キャンセル状態かどうかを判定
- `overdue?`: 期限切れかどうかを判定（予定状態で当番日が過去）

## サービス仕様

### AssignmentService

#### 概要

当番の自動割り当てロジックを管理するサービスクラス

#### 初期化

- `initialize(assignment_date, method)`
  - assignment_date: 当番日（デフォルト: 今日）
  - method: 割り当て方法（custom、デフォルト: custom）

#### メソッド

- `assign_duty`: 当番を割り当てる
- `self.available_methods`: 利用可能な割り当て方法を取得

#### 割り当て方法

1. **custom**: 当番回数が最も少ないユーザーを選択（割り当て制）

#### 除外条件

- 休暇中のユーザー（`available_for_duty?`がfalseのユーザー）
- 同じ日に既に当番が割り当てられている場合は既存の当番を返す

## コントローラー機能

### UsersController

#### アクション

1. **index**: 全ユーザー一覧表示
2. **show**: 個別ユーザー詳細表示
3. **new**: 新規ユーザー作成フォーム
4. **create**: 新規ユーザー作成処理
5. **edit**: ユーザー編集フォーム
6. **update**: ユーザー更新処理
7. **destroy**: ユーザー削除処理

#### パラメーター

許可されるパラメーター：
- name
- email
- slack_id
- vacation_start_date
- vacation_end_date

### AssignmentsController

#### アクション

1. **index**: 当番管理一覧表示
2. **show**: 個別当番詳細表示
3. **new**: 新規当番割り当てフォーム
4. **create**: 新規当番割り当て処理
5. **edit**: 当番編集フォーム
6. **update**: 当番更新処理
7. **destroy**: 当番削除処理
8. **complete**: 当番完了処理
9. **cancel**: 当番キャンセル処理
10. **assign_today**: 今日の当番を自動割り当て
11. **assign_week**: 今週の当番を一括割り当て

#### パラメーター

許可されるパラメーター：
- assignment_date
- assignment_method
- user_id

## ユーザーインターフェース

### 一覧画面（index）

- **表示形式**: カード形式のレイアウト
- **表示情報**:
  - ユーザー名
  - メールアドレス
  - Slack ID
  - 休暇中の場合：休暇期間表示
- **操作**:
  - 新規メンバー追加ボタン
  - 各ユーザーの詳細・編集・削除ボタン
- **空状態**: メンバーがいない場合の案内メッセージ

### 入力フォーム（new/edit）

- **必須フィールド**:
  - 名前
  - メールアドレス
  - Slack ID
- **オプションフィールド**:
  - 休暇開始日
  - 休暇終了日
- **バリデーション**: クライアントサイドでのBootstrap validation
- **ヘルプテキスト**: 各フィールドの説明

### 当番管理画面

#### 一覧画面（index）

- **表示セクション**:
  - 今日の当番表示
  - 今週の当番表示
  - 当番履歴

- **今日の当番**:
  - 当番者情報（名前、割り当て方法）
  - 完了・キャンセルボタン（予定状態の場合）
  - 割り当てボタン（未割り当ての場合）

- **今週の当番**:
  - 今週の当番一覧（日付、当番者、方法、状態）
  - 今週一括割り当てボタン

- **当番履歴**:
  - 過去の当番一覧（日付、当番者、方法、状態、完了日時）
  - 各当番の操作ボタン（詳細、完了、キャンセル、削除）

#### 詳細画面（show）

- **当番情報**:
  - 当番者の詳細情報
  - 当番日、割り当て方法、状態
  - 完了日時（完了済みの場合）

- **サイドバー**:
  - アクションボタン（完了、キャンセル）
  - 当番者統計（完了回数、前回当番、休暇状況）

#### 新規作成画面（new）

- **フォームフィールド**:
  - 当番日（デフォルト: 今日）
  - 割り当て方法のみ

- **説明テキスト**:
  - 割り当て方法の説明
  - 注意事項

#### 編集画面（edit）

- **フォームフィールド**:
  - 当番者選択
  - 当番日
  - 割り当て方法

- **注意事項**:
  - 編集の影響についての警告

## ルーティング

```ruby
resources :users  # RESTfulルート
resources :assignments do  # 当番管理のRESTfulルート
  member do
    patch :complete    # 当番完了
    patch :cancel      # 当番キャンセル
  end
  collection do
    post :assign_today  # 今日の当番割り当て
    post :assign_week   # 今週の当番一括割り当て
  end
end
root "users#index"  # ルートパス
```

## 業務ルール

1. **休暇管理**:
   - 休暇期間設定により一時的に当番対象外
   - 休暇開始日・終了日の両方設定時に有効
   - 現在日付が休暇期間内の場合は「休暇中」として表示

2. **当番割り当て対象**:
   - 休暇中でないユーザー
   - `available_for_duty?`メソッドで判定

3. **データ整合性**:
   - メールアドレスとSlack IDの重複不可
   - 必須フィールドの入力チェック

4. **当番割り当てルール**:
   - 同じ日に複数の当番割り当て不可
   - 休暇中のユーザーは自動的に除外
   - 利用可能なユーザーがいない場合はエラー
   - 土日は自動割り当て対象外（今週一括割り当て時）

5. **当番状態管理**:
   - pending（予定）: 割り当て直後の状態
   - completed（完了）: 当番実行完了状態
   - cancelled（キャンセル）: 当番キャンセル状態
   - 期限切れ判定: 予定状態で当番日が過去の場合

6. **割り当て方法**:
   - custom: 当番回数が最も少ないユーザーを選択（割り当て制）

## 通知・連携

- **Slack連携**: slack_idを使用してSlack通知を送信
- **メール通知**: emailアドレスを使用してメール通知を送信（将来的な機能）
- **当番通知**: 当番者への自動リマインド通知（将来的な機能）
- **当番完了通知**: 当番完了時の通知（将来的な機能）

## セキュリティ

- Strong Parametersによる許可パラメーターの制限
- データベースレベルでの制約によるデータ整合性保証
- 削除時の確認ダイアログ

## 今後の拡張予定

### ユーザー管理機能
- ユーザー権限管理
- プロファイル画像のアップロード
- 部署・チーム分け機能
- 通知設定の個別管理

### 当番管理機能
- 当番スケジュールの月次表示
- 当番テンプレート機能（定期的な当番パターン）
- 当番の代理機能
- 当番統計・レポート機能
- 当番負荷の可視化
- 祝日対応（祝日の当番スキップ）
- 当番リマインド通知の自動化
- 当番完了時の自動通知
- 当番交代申請機能

### 生成AI連携機能
- スピーチネタの自動生成・提案
- 当番者向けのアイスブレイクコンテンツ提案
- 当番履歴に基づく最適な割り当て提案

## 変更履歴

### 2025-01-28: ランダム割り当て機能削除
- **変更内容**: ランダム割り当て機能を削除し、割り当て（custom）のみに統一
- **影響範囲**:
  - AssignmentService: randomメソッドを削除、デフォルト値をcustomに変更
  - AssignmentsController: 全てのデフォルト値をcustomに変更
  - ビューファイル: ランダム選択肢とボタンを削除
  - DutyAssignmentモデル: バリデーションからrandomを削除
  - テストフィクスチャ: assignment_methodをcustomに変更
- **理由**: 効率的な当番割り当てを実現するため、ランダム要素を排除
- **互換性**: 既存のrandomで作成されたレコードは維持されるが、新規作成時はcustomのみ選択可能

### 2025-01-28: 公平割り当て機能名称変更
- **変更内容**: 「公平割り当て機能」を「割り当て機能」に名称変更
- **影響範囲**:
  - ビューファイル: 「公平割り当て」ボタンを「割り当て」ボタンに変更
  - ビューファイル: 「今週を公平に割り当て」ボタンを「今週を割り当て」ボタンに変更
  - フォーム選択肢: 「公平（当番回数が少ない順）」を「割り当て（当番回数が少ない順）」に変更
  - 詳細画面: 割り当て方法の表示名を「割り当て（当番回数が少ない順）」に変更
  - 機能仕様書: 「公平制」を「割り当て制」に変更
- **理由**: より分かりやすい名称に統一するため
- **互換性**: 機能自体は変更なし、表示名のみの変更


- 当番履歴に基づく最適な割り当て提案

