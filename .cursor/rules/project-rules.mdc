---
alwaysApply: true
---
# アイスブレイクアプリ - 機能仕様書

## データベース構造

### Usersテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|-----|-----|
| id | integer | PRIMARY KEY | 自動増分ID |
| name | string | NOT NULL | ユーザー名 |
| email | string | NOT NULL, UNIQUE | メールアドレス |
| slack_id | string | NOT NULL, UNIQUE | Slack ID |
| vacation_start_date | date | NULL可 | 休暇開始日 |
| vacation_end_date | date | NULL可 | 休暇終了日 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

### インデックス

- `email`カラムに一意インデックス

### DutyAssignmentsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|-----|-----|
| id | integer | PRIMARY KEY | 自動増分ID |
| user_id | integer | NOT NULL, FOREIGN KEY | ユーザーID（外部キー） |
| assignment_date | date | NOT NULL | 当番日 |
| status | string | NOT NULL | 状態（pending/completed/cancelled） |
| completed_at | datetime | NULL可 | 完了日時 |
| created_at | datetime | NOT NULL | 作成日時 |
| updated_at | datetime | NOT NULL | 更新日時 |

### インデックス

- `user_id`カラムに外部キーインデックス
- `assignment_date`カラムにインデックス

### データベース設定

#### データベース管理システム

- **全環境でPostgreSQLを使用**
  - 開発環境: PostgreSQL (`ice_breakun2_development`)
  - テスト環境: PostgreSQL (`ice_breakun2_test`)
  - 本番環境: PostgreSQL

## モデル仕様

### Userモデル

#### バリデーション

- **name**: 必須入力
- **email**: 必須入力、重複不可、有効なメールアドレス形式
- **slack_id**: 必須入力、重複不可

#### 関連付け

- `has_many :duty_assignments, dependent: :destroy`

#### メソッド

- `on_vacation?`: 現在休暇中かどうかを判定
- `available_for_duty?`: 当番割り当て可能かどうかを判定（休暇中でない）
- `full_name`: フルネームを返す（現在はnameと同じ）
- `last_duty_assignment`: 最新の当番割り当てを取得
- `total_duty_count`: 完了した当番の総数を取得

### DutyAssignmentモデル

#### バリデーション

- **assignment_date**: 必須入力
- **status**: 必須入力、pending/completed/cancelledのいずれか

#### 関連付け

- `belongs_to :user`

#### スコープ

- `pending`: 予定状態の当番を取得
- `completed`: 完了状態の当番を取得
- `for_date(date)`: 指定日の当番を取得
- `recent`: 日付の降順で取得

#### メソッド

- `mark_as_completed!`: 当番を完了状態にする
- `mark_as_cancelled!`: 当番をキャンセル状態にする
- `pending?`: 予定状態かどうかを判定
- `completed?`: 完了状態かどうかを判定
- `cancelled?`: キャンセル状態かどうかを判定
- `overdue?`: 期限切れかどうかを判定（予定状態で当番日が過去）

## サービス仕様

### AssignmentService

#### 概要

当番の自動割り当てロジックを管理するサービスクラス

#### 初期化

- `initialize(assignment_date)`
  - assignment_date: 当番日（デフォルト: 今日）

#### メソッド

- `assign_duty`: 当番を自動割り当てする
- `assign_duty_to_user(user)`: 指定されたユーザーに当番を手動割り当てする
- `update_duty_assignment(user)`: 既存の当番の担当者を更新する

#### 割り当て方法

- **自動割り当て**：当番回数が最も少ないユーザーを選択（割り当て制）
- **手動割り当て**：指定されたユーザーに直接割り当て

#### 除外条件・制約

- **自動割り当て**：
  - 休暇中のユーザー（`available_for_duty?`がfalseのユーザー）
  - 同じ日に既に当番が割り当てられている場合は既存の当番を返す
- **手動割り当て**：
  - 休暇中のユーザーを選択した場合はエラー
  - 同じ日に既に当番が割り当てられている場合はエラー
- **担当者更新**：
  - 休暇中のユーザーを選択した場合はエラー
  - 当番が存在しない場合はエラー

## コントローラー機能

### HomeController

#### アクション

1. **index**: トップページ（ウェルカムページ）表示

#### 機能

- アプリケーションの概要を表示
- メンバー管理と当番管理への導線を提供
- public/icon.pngを中心に「アイスブレイ君」タイトルを表示
- シンプルで直感的なUI

### UsersController

#### アクション

1. **index**: 全ユーザー一覧表示
2. **show**: 個別ユーザー詳細表示
3. **new**: 新規ユーザー作成フォーム
4. **create**: 新規ユーザー作成処理
5. **edit**: ユーザー編集フォーム
6. **update**: ユーザー更新処理
7. **destroy**: ユーザー削除処理

#### パラメーター

許可されるパラメーター：
- name
- email
- slack_id
- vacation_start_date
- vacation_end_date

### AssignmentsController

#### アクション

1. **index**: 当番管理一覧表示（今日、明日、明後日の当番を表示）
2. **show**: 個別当番詳細表示
3. **new**: 新規当番割り当てフォーム
4. **create**: 新規当番割り当て処理（自動割り当て・手動割り当て対応）
5. **edit**: 当番編集フォーム
6. **update**: 当番更新処理
7. **destroy**: 当番削除処理
8. **complete**: 当番完了処理
9. **cancel**: 当番キャンセル処理
10. **assign_today**: 今日の当番を自動割り当て
11. **assign_for_date**: 指定日の当番を自動割り当て
12. **update_tomorrow**: 明日の当番の担当者を更新
13. **update_day_after_tomorrow**: 明後日の当番の担当者を更新

#### パラメーター

許可されるパラメーター：
- assignment_date
- user_id（手動割り当て時のみ、空の場合は自動割り当て）
- date（assign_for_dateアクション用、割り当て日指定）

#### create処理の動作

- **user_idが指定されている場合**：指定されたユーザーに手動割り当て
- **user_idが空の場合**：自動割り当て（当番回数が最も少ないユーザーを選択）
- 両方とも休暇中ユーザーや既存割り当てのチェックを実行

#### assign_for_date処理の動作

- **date パラメーターで指定された日付**：指定された日付に自動割り当て
- **明日の割り当て**：「明日の当番が割り当てられました」メッセージを表示
- **明後日の割り当て**：「明後日の当番が割り当てられました」メッセージを表示
- **その他の日付**：「MM月DD日の当番が割り当てられました」メッセージを表示

## ユーザーインターフェース

### トップページ（ウェルカムページ）

- **表示形式**: 中央配置のシンプルなレイアウト
- **表示要素**:
  - 「アイスブレイ君」タイトル（display-4サイズ）
  - public/icon.pngを中央に表示（丸型、最大200px）
  - アプリケーションの説明文
  - メンバー管理と当番管理への大きなボタン
- **デザイン**:
  - レスポンシブデザイン（モバイル対応）
  - 画面中央に配置
  - Bootstrap 5のスタイリング使用
- **技術的注意点**:
  - `image_tag "/icon.png"`でpublic/icon.pngを直接参照
  - アセットパイプラインではなく、publicディレクトリから直接読み込み

### ユーザー一覧画面（index）

- **表示形式**: カード形式のレイアウト
- **表示情報**:
  - ユーザー名
  - メールアドレス
  - Slack ID
  - 休暇中の場合：休暇期間表示
- **操作**:
  - 新規メンバー追加ボタン
  - 各ユーザーの詳細・編集・削除ボタン
- **空状態**: メンバーがいない場合の案内メッセージ

### 入力フォーム（new/edit）

- **必須フィールド**:
  - 名前
  - メールアドレス
  - Slack ID
- **オプションフィールド**:
  - 休暇開始日
  - 休暇終了日
- **バリデーション**: クライアントサイドでのBootstrap validation
- **ヘルプテキスト**: 各フィールドの説明

### 当番管理画面

#### 一覧画面（index）

- **表示セクション**:
  - 今日の当番表示
  - 明日の当番表示
  - 明後日の当番表示

- **今日の当番**:
  - 当番者情報（名前）
  - 完了・キャンセルボタン（予定状態の場合）
  - 割り当てボタン（未割り当ての場合）

- **明日・明後日の当番**:
  - 当番者情報（名前）
  - 状態バッジ（予定/完了/キャンセル）
  - 割り当てボタン（未割り当ての場合）
  - 担当者更新セレクトボックス（予定状態の場合）
    - 全ユーザーをドロップダウンから選択可能
    - 現在の担当者が初期選択状態
    - 「更新」ボタンで担当者を変更
    - 休暇中のユーザーは選択不可

#### 詳細画面（show）

- **当番情報**:
  - 当番者の詳細情報
  - 当番日、状態
  - 完了日時（完了済みの場合）

- **サイドバー**:
  - アクションボタン（完了、キャンセル）
  - 当番者統計（完了回数、前回当番、休暇状況）

#### 新規作成画面（new）

- **フォームフィールド**:
  - 当番日（デフォルト: 今日）
  - 担当者（自動割り当て または 手動選択）

- **担当者選択機能**:
  - 自動割り当て：当番回数が最も少ないユーザーを自動選択
  - 手動割り当て：ドロップダウンから特定のユーザーを選択
  - 休暇中のユーザーは休暇期間を併記表示（例：「田中太郎 (休暇中 01/15-01/20)」）

- **説明テキスト**:
  - 注意事項
  - 休暇中ユーザー選択時のエラー警告

#### 編集画面（edit）

- **フォームフィールド**:
  - 当番者選択
  - 当番日

- **注意事項**:
  - 編集の影響についての警告

## ルーティング

```ruby
resources :users  # RESTfulルート
resources :assignments do  # 当番管理のRESTfulルート
  member do
    patch :complete    # 当番完了
    patch :cancel      # 当番キャンセル
  end
  collection do
    post :assign_today     # 今日の当番割り当て
    post :assign_for_date  # 指定日の当番割り当て
    patch :update_tomorrow # 明日の当番の担当者更新
    patch :update_day_after_tomorrow # 明後日の当番の担当者更新
  end
end
root "home#index"  # ルートパス（トップページ）
```

## 業務ルール

1. **休暇管理**:
   - 休暇期間設定により一時的に当番対象外
   - 休暇開始日・終了日の両方設定時に有効
   - 現在日付が休暇期間内の場合は「休暇中」として表示

2. **当番割り当て対象**:
   - 休暇中でないユーザー
   - `available_for_duty?`メソッドで判定

3. **データ整合性**:
   - メールアドレスとSlack IDの重複不可
   - 必須フィールドの入力チェック

4. **当番割り当てルール**:
   - 同じ日に複数の当番割り当て不可
   - 休暇中のユーザーは自動的に除外
   - 利用可能なユーザーがいない場合はエラー

5. **当番状態管理**:
   - pending（予定）: 割り当て直後の状態
   - completed（完了）: 当番実行完了状態
   - cancelled（キャンセル）: 当番キャンセル状態
   - 期限切れ判定: 予定状態で当番日が過去の場合

6. **割り当て方法**:
   - **自動割り当て**：当番回数が最も少ないユーザーを選択（割り当て制）
   - **手動割り当て**：指定されたユーザーに直接割り当て（休暇中チェック有り）

7. **3日間の当番表示**:
   - 今日、明日、明後日の当番を一覧で表示
   - 各日の当番状態（予定/完了/キャンセル）を視覚的に表示
   - 未割り当ての日は自動割り当てボタンを表示
   - 今日の当番のみ完了・キャンセルボタンを表示

8. **担当者更新**:
   - 明日と明後日の当番担当者を更新可能
   - 予定状態（pending）の当番のみ更新可能
   - 完了済みまたはキャンセル済みの当番は更新不可
   - 休暇中のユーザーは選択不可

## 通知・連携

- **Slack連携**: slack_idを使用してSlack通知を送信
- **当番割り当て通知**: 新しい当番が割り当てられた時の通知
- **当番変更通知**: 既存の当番の担当者が変更された時の通知
- **メール通知**: emailアドレスを使用してメール通知を送信（将来的な機能）
- **当番通知**: 当番者への自動リマインド通知（将来的な機能）
- **当番完了通知**: 当番完了時の通知（将来的な機能）

## セキュリティ

- Strong Parametersによる許可パラメーターの制限
- データベースレベルでの制約によるデータ整合性保証
- 削除時の確認ダイアログ

## 今後の拡張予定

### ユーザー管理機能
- ユーザー権限管理
- プロファイル画像のアップロード
- 部署・チーム分け機能
- 通知設定の個別管理

### 当番管理機能
- 当番スケジュールの月次表示
- 当番テンプレート機能（定期的な当番パターン）
- 当番の代理機能
- 当番統計・レポート機能
- 当番負荷の可視化
- 祝日対応（祝日の当番スキップ）
- 当番リマインド通知の自動化
- 当番完了時の自動通知
- 当番交代申請機能
- ~~手動割り当て機能（担当者選択）~~ **✅ 実装済み**
- ~~3日間の当番表示機能（今日・明日・明後日）~~ **✅ 実装済み**
- ~~翌日・翌々日の担当者更新機能~~ **✅ 実装済み**

### 生成AI連携機能
- スピーチネタの自動生成・提案
- 当番者向けのアイスブレイクコンテンツ提案
- 当番履歴に基づく最適な割り当て提案
